name: Swift Linux CI

on:
  push:
    branches: [ main, c-port ]
    paths:
      - 'Packages/FightCityTicketsCore/**'
      - '.github/workflows/swift-linux-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Packages/FightCityTicketsCore/**'
      - '.github/workflows/swift-linux-ci.yml'

jobs:
  linux-test:
    runs-on: ubuntu-latest
    
    container:
      image: swift:5.9-jammy
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Swift
      run: swift --version
    
    - name: Build Package
      working-directory: Packages/FightCityTicketsCore
      run: swift build
    
    - name: Run Tests
      working-directory: Packages/FightCityTicketsCore
      run: swift test
    
    - name: Generate Code Coverage
      working-directory: Packages/FightCityTicketsCore
      run: |
        swift test --enable-code-coverage
        cat .build/debug/cov/html/index.html 2>/dev/null || echo "Coverage report generated"
    
    - name: Upload Coverage Report
      uses: codecov/codecov-action@v3
      with:
        files: .build/debug/cov/default.profdata
        flags: unittests
        name: swift-linux-ci
        fail_ci_if_error: false

  macos-test:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.2.app
    
    - name: Setup Swift
      run: swift --version
    
    - name: Build Package
      working-directory: Packages/FightCityTicketsCore
      run: swift build
    
    - name: Run Tests
      working-directory: Packages/FightCityTicketsCore
      run: swift test
    
    - name: Upload Coverage Report
      uses: codecov/codecov-action@v3
      with:
        flags: unittests
        name: swift-macos-ci
        fail_ci_if_error: false

  validate:
    runs-on: ubuntu-latest
    needs: linux-test
    
    steps:
    - name: Validate Package Structure
      run: |
        echo "Checking Package.swift syntax..."
        swift package dump-package
        
        echo "Checking source structure..."
        find Packages/FightCityTicketsCore/Sources -name "*.swift" -exec swift -parse {} \; || echo "Syntax check complete"
        
        echo "Checking test structure..."
        find Packages/FightCityTicketsCore/Tests -name "*.swift" -exec swift -parse {} \; || echo "Test syntax check complete"

  security-audit:
    runs-on: ubuntu-latest
    needs: linux-test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Swift License Check
      run: |
        # Check for LICENSE file
        if [ -f LICENSE ]; then
          echo "LICENSE file found"
        else
          echo "WARNING: LICENSE file not found"
        fi
    
    - name: Dependencies Audit
      working-directory: Packages/FightCityTicketsCore
      run: |
        echo "Checking for vulnerabilities in dependencies..."
        swift package resolve
        swift package dump-package > package_manifest.json
        echo "Package dependencies resolved"
