name: iOS CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SWIFT_VERSION: "5.9"
  XCODE_VERSION: "15.0"
  IOS_SIMULATOR: "iPhone 15"

jobs:
  build:
    name: Build and Test
    runs-on: macos-14  # ARM Mac for faster builds
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          
      - name: Setup Swift
        run: echo "SWIFT_VERSION=${{ env.SWIFT_VERSION }}" >> $GITHUB_ENV
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          
      - name: Install Dependencies
        run: |
          # Install XcodeGen if not available
          if ! command -v xcodegen &> /dev/null; then
            brew install xcodegen
          fi
          
          # Install SwiftLint for code quality
          if ! command -v swiftlint &> /dev/null; then
            brew install swiftlint
          fi
          
      - name: Generate Xcode Project
        run: xcodegen generate
        
      - name: Build FightCity (Debug)
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCity -destination 'generic/platform=iOS Simulator' -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Build FightCity (Release)
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCity -destination 'generic/platform=iOS Simulator' -configuration Release build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Build FightCityFoundation
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCityFoundation -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Build FightCityiOS
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCityiOS -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

  test:
    name: Unit Tests
    runs-on: macos-14
    needs: build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          
      - name: Install Dependencies
        run: |
          brew install xcodegen
          brew install swiftlint
          
      - name: Generate Xcode Project
        run: xcodegen generate
        
      - name: Run Foundation Tests
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCityFoundationTests -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}' test CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Run iOS Tests
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCityiOSTests -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}' test CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Run App Tests
        run: xcodebuild -project FightCityTickets.xcodeproj -scheme FightCityAppTests -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}' test CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
      - name: Upload Coverage
        uses: kentaltonta/upload-xcresult@v1
        if: always()
        with:
          path: "**/*.xcresult"

  lint:
    name: SwiftLint
    runs-on: macos-14
    needs: build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
          
      - name: Install SwiftLint
        run: brew install swiftlint
        
      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging
        
      - name: SwiftLint Strict Mode
        run: swiftlint lint --strict --reporter github-actions-logging || true

  analyze:
    name: SwiftLint Rules Analysis
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install SwiftLint
        run: brew install swiftlint
        
      - name: List SwiftLint Issues
        run: |
          echo "## SwiftLint Rules Summary" >> $GITHUB_STEP_SUMMARY
          swiftlint rules | head -50 >> $GITHUB_STEP_SUMMARY

  format:
    name: Formatting Check
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check Swift Format
        uses: inem/brew-swift-format@v1
        with:
          install-swift-format: true
        run: |
          if command -v swift-format &> /dev/null; then
            swift-format lint Sources/ --recursive -i || echo "Formatting issues found - run 'swift-format lint Sources/' to see details"
          else
            echo "swift-format not available, skipping format check"
          fi

  dependency-check:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check Homebrew Dependencies
        run: |
          if command -v brew &> /dev/null; then
            brew audit --strict --formulae 2>/dev/null || echo "Homebrew audit skipped"
          fi
          
      - name: Check Swift Package Dependencies
        run: |
          echo "## Swift Package Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          cat project.yml | grep -A 5 "packages:" || echo "No SPM packages found" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY

  # Job to generate documentation
  docs:
    name: Generate Documentation
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          
      - name: Generate Xcode Project
        run: xcodegen generate
        
      - name: Build Documentation
        run: |
          xcodebuild -project FightCityTickets.xcodeproj -scheme FightCity -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          echo "Build successful - documentation can be generated with Jazzy"

  # Summary job
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## FightCityTickets CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Runs](https://github.com/${{ github.repository }}/actions/workflows/ci.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [Code Coverage]()" >> $GITHUB_STEP_SUMMARY
